<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>打造多檔案結構的json-server | Billy Chin</title>
    <meta name="generator" content="VuePress 1.9.7">
    <link rel="alternate" type="application/rss+xml" href="https://billyyyyy3320.com/rss.xml" title="Billy Chin RSS Feed">
    <meta name="description" content="有了json-server前端可以繼續開發不依賴後端，但是只有單一json檔案入口，維護太麻煩了，不如把它依照ＡＰＩ拆分成多個獨立檔案，讓開發更順手。">
    
    <link rel="preload" href="/notes/assets/css/0.styles.dd430f05.css" as="style"><link rel="preload" href="/notes/assets/js/app.58d3274d.js" as="script"><link rel="preload" href="/notes/assets/js/10.1c61ee65.js" as="script"><link rel="preload" href="/notes/assets/js/1.cefec5dd.js" as="script"><link rel="preload" href="/notes/assets/js/26.9b23ff55.js" as="script"><link rel="preload" href="/notes/assets/js/5.32c25227.js" as="script"><link rel="preload" href="/notes/assets/js/11.dc79e7dc.js" as="script"><link rel="prefetch" href="/notes/assets/js/12.0d6e1e2a.js"><link rel="prefetch" href="/notes/assets/js/13.62a57153.js"><link rel="prefetch" href="/notes/assets/js/14.37f3d230.js"><link rel="prefetch" href="/notes/assets/js/15.79885d8b.js"><link rel="prefetch" href="/notes/assets/js/16.e4cd4d03.js"><link rel="prefetch" href="/notes/assets/js/17.775f6e6c.js"><link rel="prefetch" href="/notes/assets/js/18.33771f84.js"><link rel="prefetch" href="/notes/assets/js/19.28476f19.js"><link rel="prefetch" href="/notes/assets/js/20.d0956512.js"><link rel="prefetch" href="/notes/assets/js/21.d2a932b5.js"><link rel="prefetch" href="/notes/assets/js/22.b61847dc.js"><link rel="prefetch" href="/notes/assets/js/23.e85806c4.js"><link rel="prefetch" href="/notes/assets/js/24.3bc4fa61.js"><link rel="prefetch" href="/notes/assets/js/25.fe29317a.js"><link rel="prefetch" href="/notes/assets/js/4.9634bdd5.js"><link rel="prefetch" href="/notes/assets/js/6.1bb32538.js"><link rel="prefetch" href="/notes/assets/js/7.d71d51da.js"><link rel="prefetch" href="/notes/assets/js/8.01f3078f.js"><link rel="prefetch" href="/notes/assets/js/9.1e39f892.js"><link rel="prefetch" href="/notes/assets/js/vuejs-paginate.bcf40e38.js">
    <link rel="stylesheet" href="/notes/assets/css/0.styles.dd430f05.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div id="vuepress-theme-blog__global-layout"><section id="header-wrapper"><header id="header"><div class="header-wrapper"><div class="title"><a href="/notes/" class="nav-link home-link">Billy Chin </a></div> <div class="header-right-wrap"><ul class="nav"><li class="nav-item"><a href="/notes/zh/" class="nav-link router-link-active">部落格</a></li><li class="nav-item"><a href="/notes/en/" class="nav-link">Blog</a></li><li class="nav-item"><a href="https://github.com/billyyyyy3320" target="_blank" rel="noopener noreferrer" class="nav-link external">Github</a></li></ul> <div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <a href="/notes/rss.xml" class="feed"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-rss"><path d="M4 11a9 9 0 0 1 9 9"></path><path d="M4 4a16 16 0 0 1 16 16"></path><circle cx="5" cy="19" r="1"></circle></svg></a></div></div></header></section> <div id="mobile-header"><div class="mobile-header-bar"><div class="mobile-header-title"><a href="/notes/" class="nav-link mobile-home-link">Billy Chin </a> <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-menu"><line x1="3" y1="12" x2="21" y2="12"></line><line x1="3" y1="6" x2="21" y2="6"></line><line x1="3" y1="18" x2="21" y2="18"></line></svg></div> <div class="mobile-menu-wrapper"><hr class="menu-divider"> <ul class="mobile-nav"><li class="mobile-nav-item"><a href="/notes/zh/" class="nav-link router-link-active">部落格</a></li><li class="mobile-nav-item"><a href="/notes/en/" class="nav-link">Blog</a></li><li class="mobile-nav-item"><a href="https://github.com/billyyyyy3320" target="_blank" rel="noopener noreferrer" class="nav-link external">Github</a></li> <li class="mobile-nav-item"><a href="/notes/rss.xml" class="feed"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-rss"><path d="M4 11a9 9 0 0 1 9 9"></path><path d="M4 4a16 16 0 0 1 16 16"></path><circle cx="5" cy="19" r="1"></circle></svg></a></li></ul></div></div></div> <div class="content-wrapper"><div id="vuepress-theme-blog__post-layout"><article itemscope="itemscope" itemtype="https://schema.org/BlogPosting" class="vuepress-blog-theme-content"><header><h1 itemprop="name headline" class="post-title">
        打造多檔案結構的json-server
      </h1> <div class="post-meta"><!----> <div class="post-meta-date"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-clock"><circle cx="12" cy="12" r="10"></circle><polyline points="12 6 12 12 16 14"></polyline></svg> <time pubdate itemprop="datePublished" datetime="2019-07-21T00:00:00.000Z">
      Sun Jul 21 2019
    </time></div> <ul itemprop="keywords" class="post-meta-tags"><li class="post-tag" data-v-42ccfcd5><a href="/notes/tag/JavaScript" data-v-42ccfcd5><span data-v-42ccfcd5>JavaScript</span></a></li></ul></div></header> <div itemprop="articleBody" class="content__default"><p>繁體中文 | <a href="/notes/en/2019/07/21/create-json-server-with-multiple-files/">English</a></p> <h2 id="前言"><a href="#前言" class="header-anchor">#</a> 前言</h2> <p>先附上<a href="https://github.com/billyyyyy3320/json-server-mulitple-files-sample" target="_blank" rel="noopener noreferrer">範例<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p> <p>這篇文章只是分享我自己運用的方法，或許有更好的方法也說不定。</p> <h3 id="json-server-能幹麻"><a href="#json-server-能幹麻" class="header-anchor">#</a> <code>json-server</code> 能幹麻</h3> <p>先簡單看過 json-server 提供的 <a href="https://github.com/typicode/json-server#getting-started" target="_blank" rel="noopener noreferrer">Getting started<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>：</p> <p>Create a <code>db.json</code> file with some data</p> <div class="language- extra-class"><pre class="language-text"><code>{
  &quot;posts&quot;: [
    { &quot;id&quot;: 1, &quot;title&quot;: &quot;json-server&quot;, &quot;author&quot;: &quot;typicode&quot; }
  ],
  &quot;comments&quot;: [
    { &quot;id&quot;: 1, &quot;body&quot;: &quot;some comment&quot;, &quot;postId&quot;: 1 }
  ],
  &quot;profile&quot;: { &quot;name&quot;: &quot;typicode&quot; }
}
</code></pre></div><p>Start JSON Server</p> <div class="language- extra-class"><pre class="language-text"><code>json-server --watch db.json
</code></pre></div><p>Now if you go to http://localhost:3000/posts/1, you'll get</p> <div class="language- extra-class"><pre class="language-text"><code>{ &quot;id&quot;: 1, &quot;title&quot;: &quot;json-server&quot;, &quot;author&quot;: &quot;typicode&quot; }
</code></pre></div><p>就那麼簡單，但是實際專案中資料會更龐大複雜，需要更多 API 接口，於是我決定為每個 API 對應一個檔案。</p> <h2 id="開始"><a href="#開始" class="header-anchor">#</a> 開始</h2> <p>當下版本為 <code>&quot;json-server&quot;: &quot;^0.15.0&quot;</code></p> <h3 id="建立多檔案結構"><a href="#建立多檔案結構" class="header-anchor">#</a> 建立多檔案結構</h3> <p>建立新的資料夾<code>mock</code>，並在<code>package.json</code>寫個 script：</p> <div class="language-json extra-class"><pre class="language-json"><code><span class="token property">&quot;scripts&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
  <span class="token property">&quot;mock&quot;</span><span class="token operator">:</span> <span class="token string">&quot;json-server --watch ./mock/db.js&quot;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>首先 db.json 可以改成 js 的格式：</p> <div class="language-JavaScript extra-class"><pre class="language-javascript"><code><span class="token comment">// db.js</span>
<span class="token comment">// 必須是回傳一個return物件的function</span>
module<span class="token punctuation">.</span><span class="token function-variable function">exports</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">(</span><span class="token punctuation">{</span>
  <span class="token literal-property property">posts</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token punctuation">{</span> <span class="token literal-property property">id</span><span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token literal-property property">title</span><span class="token operator">:</span> <span class="token string">&quot;json-server&quot;</span><span class="token punctuation">,</span> <span class="token literal-property property">author</span><span class="token operator">:</span> <span class="token string">&quot;typicode&quot;</span> <span class="token punctuation">}</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
  <span class="token literal-property property">comments</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token punctuation">{</span> <span class="token literal-property property">id</span><span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token literal-property property">body</span><span class="token operator">:</span> <span class="token string">&quot;some comment&quot;</span><span class="token punctuation">,</span> <span class="token literal-property property">postId</span><span class="token operator">:</span> <span class="token number">1</span> <span class="token punctuation">}</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
  <span class="token literal-property property">profile</span><span class="token operator">:</span> <span class="token punctuation">{</span> <span class="token literal-property property">name</span><span class="token operator">:</span> <span class="token string">&quot;typicode&quot;</span> <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>既然是 js，代表我們可以引入其他檔案：</p> <div class="language-JavaScript extra-class"><pre class="language-javascript"><code><span class="token comment">// db.js</span>
<span class="token keyword">const</span> posts <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&quot;./posts&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> comments <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&quot;./comments&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> profile <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&quot;./profile&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
module<span class="token punctuation">.</span><span class="token function-variable function">exports</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">(</span><span class="token punctuation">{</span>
  posts<span class="token punctuation">,</span>
  comments<span class="token punctuation">,</span>
  profile
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>新建對應檔案 例如：</p> <div class="language-JavaScript extra-class"><pre class="language-javascript"><code><span class="token comment">// posts.js</span>
module<span class="token punctuation">.</span>exports <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">{</span> <span class="token literal-property property">id</span><span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token literal-property property">title</span><span class="token operator">:</span> <span class="token string">&quot;json-server&quot;</span><span class="token punctuation">,</span> <span class="token literal-property property">author</span><span class="token operator">:</span> <span class="token string">&quot;typicode&quot;</span> <span class="token punctuation">}</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
</code></pre></div><h3 id="db-js-自動引入檔案"><a href="#db-js-自動引入檔案" class="header-anchor">#</a> db.js 自動引入檔案</h3> <p>可以把資料拆分到多個不同檔案了，但是每次新增一個檔案都要引入一次，有夠麻煩。</p> <p>這邊運用<a href="https://github.com/isaacs/node-glob" target="_blank" rel="noopener noreferrer">glob<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>取出檔名，我們可以動態的引入檔案：</p> <div class="language-JavaScript extra-class"><pre class="language-javascript"><code><span class="token comment">// db.js</span>
<span class="token keyword">const</span> Path <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&quot;path&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> glob <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&quot;glob&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> apiFiles <span class="token operator">=</span> glob<span class="token punctuation">.</span><span class="token function">sync</span><span class="token punctuation">(</span>Path<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span>__dirname<span class="token punctuation">,</span> <span class="token string">&quot;./&quot;</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">&quot;/**/*.js&quot;</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>
  <span class="token literal-property property">nodir</span><span class="token operator">:</span> <span class="token boolean">true</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// apiFiles會是</span>
<span class="token comment">// [ '/Users/billy/Desktop/json-server-multiple-files-sample/mock/comments.js',</span>
<span class="token comment">//   '/Users/billy/Desktop/json-server-multiple-files-sample/mock/db.js',</span>
<span class="token comment">//   '/Users/billy/Desktop/json-server-multiple-files-sample/mock/posts.js',</span>
<span class="token comment">//   '/Users/billy/Desktop/json-server-multiple-files-sample/mock/profile.js' ]</span>

<span class="token keyword">let</span> data <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">;</span>

apiFiles<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token parameter">filePath</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> api <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span>filePath<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">let</span> <span class="token punctuation">[</span><span class="token punctuation">,</span> url<span class="token punctuation">]</span> <span class="token operator">=</span> filePath<span class="token punctuation">.</span><span class="token function">split</span><span class="token punctuation">(</span><span class="token string">&quot;mock/&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// e.g. comments.js</span>
  url <span class="token operator">=</span> url<span class="token punctuation">.</span><span class="token function">slice</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> url<span class="token punctuation">.</span>length <span class="token operator">-</span> <span class="token number">3</span><span class="token punctuation">)</span>  <span class="token comment">// remove .js &gt;&gt; comments</span>
  data<span class="token punctuation">[</span>url<span class="token punctuation">]</span> <span class="token operator">=</span> api<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// data會是</span>
<span class="token comment">// { 'comments': [ { id: 1, body: 'some comment', postId: 1 } ],</span>
<span class="token comment">//   'db': {},</span>
<span class="token comment">//   'posts': [ { id: 1, title: 'json-server', author: 'typicode' } ],</span>
<span class="token comment">//   'profile': { name: 'typicode' } }</span>

module<span class="token punctuation">.</span><span class="token function-variable function">exports</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> data<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre></div><p>但是我不需要 db.js 也被拿去當 API 啊<br>
把<code>db.js</code>改名為<code>_db.js</code>，趁機改個規則 把所有開頭為<code>_</code>的檔案不視為 API 接口：</p> <div class="language-JavaScript extra-class"><pre class="language-javascript"><code><span class="token comment">// db.js</span>
<span class="token comment">// ...</span>
<span class="token keyword">const</span> apiFiles <span class="token operator">=</span> glob<span class="token punctuation">.</span><span class="token function">sync</span><span class="token punctuation">(</span>Path<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span>__dirname<span class="token punctuation">,</span> <span class="token string">&quot;./&quot;</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">&quot;/**/[!_]*.js&quot;</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>
<span class="token comment">// ...</span>
</code></pre></div><h3 id="監聽多檔案"><a href="#監聽多檔案" class="header-anchor">#</a> 監聽多檔案</h3> <p>json-server 只有在<code>_db.js</code>有更動時重啟，每當我新增 API，或修改回傳資料，我還得手動 <code>yarn mock</code>，好麻煩啊，
<a href="https://github.com/typicode/json-server/issues/434#issuecomment-273498639" target="_blank" rel="noopener noreferrer">解決方法<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>：</p> <div class="language- extra-class"><pre class="language-text"><code>yarn add -D nodemon
</code></pre></div><div class="language-json extra-class"><pre class="language-json"><code><span class="token property">&quot;scripts&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
  <span class="token property">&quot;mock&quot;</span><span class="token operator">:</span> <span class="token string">&quot;nodemon --watch mock --exec 'json-server ./mock/_db.js'&quot;</span>
<span class="token punctuation">}</span>
</code></pre></div><h3 id="更完整的-router"><a href="#更完整的-router" class="header-anchor">#</a> 更完整的 router</h3> <p>快要完成了，那 API 變得複雜點呢：</p> <div class="language- extra-class"><pre class="language-text"><code>/blog/posts
/blog/comments
/blog/profile
/documents/query
</code></pre></div><p>我希望我的 mock 資料夾結構如下：</p> <div class="language- extra-class"><pre class="language-text"><code>├── _db.js
├── blog
│   ├── comments.js
│   ├── posts.js
│   └── profile.js
└── documents
    └── query.js
</code></pre></div><p>動手修改<code>_db.js</code>規則：</p> <div class="language-JavaScript extra-class"><pre class="language-javascript"><code><span class="token comment">// db.js</span>
<span class="token keyword">const</span> Path <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'path'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> glob <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'glob'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> config <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'./config.json'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> apiFiles <span class="token operator">=</span> glob<span class="token punctuation">.</span><span class="token function">sync</span><span class="token punctuation">(</span>
  Path<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span>__dirname<span class="token punctuation">,</span> <span class="token string">'./'</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">'/**/[!_]*.js'</span><span class="token punctuation">,</span>
  <span class="token punctuation">{</span>
    <span class="token literal-property property">nodir</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">let</span> data <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">;</span>


apiFiles<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token parameter">filePath</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> api <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span>filePath<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">let</span> <span class="token punctuation">[</span><span class="token punctuation">,</span> url<span class="token punctuation">]</span> <span class="token operator">=</span> filePath<span class="token punctuation">.</span><span class="token function">split</span><span class="token punctuation">(</span><span class="token string">'mock/'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  url <span class="token operator">=</span> url<span class="token punctuation">.</span><span class="token function">slice</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> url<span class="token punctuation">.</span>length <span class="token operator">-</span> <span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  data<span class="token punctuation">[</span>url<span class="token punctuation">.</span><span class="token function">replace</span><span class="token punctuation">(</span><span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">\/</span><span class="token regex-delimiter">/</span><span class="token regex-flags">g</span></span><span class="token punctuation">,</span> <span class="token string">'-'</span><span class="token punctuation">)</span><span class="token punctuation">]</span> <span class="token operator">=</span> api<span class="token punctuation">;</span> <span class="token comment">// 只有這裡更動</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// data會是</span>
<span class="token comment">// { 'blog-comments': [ { id: 1, body: 'some comment', postId: 1 } ],</span>
<span class="token comment">//   'blog-posts': [ { id: 1, title: 'json-server', author: 'tydpicode' } ],</span>
<span class="token comment">//   'blog-profile': { name: 'typicode' },</span>
<span class="token comment">//   'documents-query': { data: 123 } }</span>

module<span class="token punctuation">.</span><span class="token function-variable function">exports</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> data<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre></div><p>建立<code>config.json</code>和<code>router.json</code>：
（<a href="https://github.com/typicode/json-server#cli-usage" target="_blank" rel="noopener noreferrer">config 配置<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a><a href="https://github.com/typicode/json-server#add-custom-routes" target="_blank" rel="noopener noreferrer">router 配置<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>）</p> <div class="language-json extra-class"><pre class="language-json"><code><span class="token comment">// config.json</span>
<span class="token punctuation">{</span>
  <span class="token property">&quot;port&quot;</span><span class="token operator">:</span> <span class="token number">9898</span><span class="token punctuation">,</span>
  <span class="token property">&quot;routes&quot;</span><span class="token operator">:</span> <span class="token string">&quot;./mock/router.json&quot;</span>
<span class="token punctuation">}</span>
</code></pre></div><div class="language-json extra-class"><pre class="language-json"><code><span class="token comment">// router.json</span>
<span class="token punctuation">{</span>
  <span class="token property">&quot;/*/*/*&quot;</span><span class="token operator">:</span> <span class="token string">&quot;/$1-$2-$3&quot;</span><span class="token punctuation">,</span>
  <span class="token property">&quot;/*/*&quot;</span><span class="token operator">:</span> <span class="token string">&quot;/$1-$2&quot;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>這樣一來 <code>/documents/query</code> 就會對應到 <code>/documents-query</code>，<br>
如果有<code>/documents/query/something</code> 那就會對應到<code>/documents-query-something</code>，完全符合現在的資料夾結構了。</p> <p>最後稍微修改一下：</p> <div class="language-JavaScript extra-class"><pre class="language-javascript"><code><span class="token comment">// _db.js</span>
<span class="token keyword">const</span> Path <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&quot;path&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> glob <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&quot;glob&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> apiFiles <span class="token operator">=</span> glob<span class="token punctuation">.</span><span class="token function">sync</span><span class="token punctuation">(</span>Path<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span>__dirname<span class="token punctuation">,</span> <span class="token string">&quot;./&quot;</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">&quot;/**/[!_]*.js&quot;</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>
  <span class="token literal-property property">nodir</span><span class="token operator">:</span> <span class="token boolean">true</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">let</span> data <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
apiFiles<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token parameter">filePath</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> api <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span>filePath<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">let</span> <span class="token punctuation">[</span><span class="token punctuation">,</span> url<span class="token punctuation">]</span> <span class="token operator">=</span> filePath<span class="token punctuation">.</span><span class="token function">split</span><span class="token punctuation">(</span><span class="token string">&quot;mock/&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  url <span class="token operator">=</span>
    url<span class="token punctuation">.</span><span class="token function">slice</span><span class="token punctuation">(</span>url<span class="token punctuation">.</span>length <span class="token operator">-</span> <span class="token number">9</span><span class="token punctuation">)</span> <span class="token operator">===</span> <span class="token string">&quot;/index.js&quot;</span>
      <span class="token operator">?</span> url<span class="token punctuation">.</span><span class="token function">slice</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> url<span class="token punctuation">.</span>length <span class="token operator">-</span> <span class="token number">9</span><span class="token punctuation">)</span> <span class="token comment">// remove /index.js</span>
      <span class="token operator">:</span> url<span class="token punctuation">.</span><span class="token function">slice</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> url<span class="token punctuation">.</span>length <span class="token operator">-</span> <span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// remove .js</span>
  data<span class="token punctuation">[</span>url<span class="token punctuation">.</span><span class="token function">replace</span><span class="token punctuation">(</span><span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">\/</span><span class="token regex-delimiter">/</span><span class="token regex-flags">g</span></span><span class="token punctuation">,</span> <span class="token string">&quot;-&quot;</span><span class="token punctuation">)</span><span class="token punctuation">]</span> <span class="token operator">=</span> api<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
module<span class="token punctuation">.</span><span class="token function-variable function">exports</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> data<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre></div><p>萬一有個 API 是<code>/documents</code> 我就能把</p> <div class="language- extra-class"><pre class="language-text"><code>├── _db.js
├── blog
│   ├── comments.js
│   ├── posts.js
│   └── profile.js
├── config.json
├── documents
│   └── query.js
├── documents.js
└── router.json
</code></pre></div><p>更條理的改成：</p> <div class="language- extra-class"><pre class="language-text"><code>├── _db.js
├── blog
│   ├── comments.js
│   ├── posts.js
│   └── profile.js
├── config.json
├── documents
│   ├── index.js
│   └── query.js
└── router.json
</code></pre></div><h2 id="其他"><a href="#其他" class="header-anchor">#</a> 其他</h2> <h3 id="中文解碼"><a href="#中文解碼" class="header-anchor">#</a> 中文解碼</h3> <p>假使我有個 API 為<code>documents/基本</code>，我是訪問不到他的。<br> <code>基本</code>會被編碼成<code>%E5%9F%BA%E6%9C%AC</code>，編碼規則是 ％加上十六進制，那就新增一個 middleware 來處理吧。<br>
每次收到 request 時都會經過 middleware，判斷 url 若包含編碼規則的字串，那就把 url 解碼。<br>
使用我前面預留的<code>_</code>作為檔名開頭:</p> <div class="language- extra-class"><pre class="language-text"><code>├── _db.js
├── blog
│   ├── comments.js
│   ├── posts.js
│   └── profile.js
├── config.json
├── documents
│   ├── index.js
│   ├── query.js
│   └── 基本.js
├── middlewares
│   ├── _decodeChinese.js
└── router.json
</code></pre></div><div class="language-JavaScript extra-class"><pre class="language-javascript"><code><span class="token comment">// _decodeChinese.js</span>
module<span class="token punctuation">.</span><span class="token function-variable function">exports</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span> res<span class="token punctuation">,</span> next</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> regex <span class="token operator">=</span> <span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">%(\d|[A-Z]){2}</span><span class="token regex-delimiter">/</span></span><span class="token punctuation">;</span>
  <span class="token keyword">const</span> isMatch <span class="token operator">=</span> regex<span class="token punctuation">.</span><span class="token function">test</span><span class="token punctuation">(</span>req<span class="token punctuation">.</span>url<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>isMatch<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    req<span class="token punctuation">.</span>url <span class="token operator">=</span> <span class="token function">decodeURI</span><span class="token punctuation">(</span>req<span class="token punctuation">.</span>url<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre></div><div class="language-json extra-class"><pre class="language-json"><code><span class="token comment">// config.json</span>
<span class="token punctuation">{</span>
  <span class="token comment">// ...</span>
  <span class="token property">&quot;middlewares&quot;</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">&quot;./mock/middlewares/_decodeChinese.js&quot;</span><span class="token punctuation">]</span>
  <span class="token comment">// ...</span>
<span class="token punctuation">}</span>
</code></pre></div><h3 id="post-轉成-get"><a href="#post-轉成-get" class="header-anchor">#</a> POST 轉成 GET</h3> <p>有時候會用 POST 來取得資料，但 json-server 提供的 custom route 都是 GET。
<a href="https://github.com/typicode/json-server/issues/453#issuecomment-343048811" target="_blank" rel="noopener noreferrer">解決方法<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a><br>
一樣使用 middleware 處理，判斷 request 的方式為 POST 時就轉成 GET。</p> <div class="language-JavaScript extra-class"><pre class="language-javascript"><code><span class="token comment">// _postAsGet.js</span>
module<span class="token punctuation">.</span><span class="token function-variable function">exports</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span> res<span class="token punctuation">,</span> next</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>req<span class="token punctuation">.</span>method <span class="token operator">===</span> <span class="token string">'POST'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// Converts POST to GET and move payload to query params</span>
    <span class="token comment">// This way it will make JSON Server that it's GET request</span>
    req<span class="token punctuation">.</span>method <span class="token operator">=</span> <span class="token string">'GET'</span><span class="token punctuation">;</span>
    req<span class="token punctuation">.</span>query <span class="token operator">=</span> req<span class="token punctuation">.</span>body<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token comment">// Continue to JSON Server router</span>
  <span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre></div><div class="language-json extra-class"><pre class="language-json"><code><span class="token comment">// config.json</span>
<span class="token punctuation">{</span>
  <span class="token comment">// ...</span>
  <span class="token property">&quot;middlewares&quot;</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">&quot;./mock/middlewares/_postAsGet.js&quot;</span><span class="token punctuation">]</span>
  <span class="token comment">// ...</span>
<span class="token punctuation">}</span>
</code></pre></div><h3 id="同時運行-app-與-mock-server-在一個-terminal"><a href="#同時運行-app-與-mock-server-在一個-terminal" class="header-anchor">#</a> 同時運行 App 與 mock server 在一個 terminal</h3> <p>你可能覺得需要開兩個 terminal，一個 <code>yarn start</code> 一個 <code>yarn mock</code>。
其實很簡單 <code>yarn mock &amp; yarn start</code> 就都會運行了，但就會發現分不出 log 是從那個 server 發出的。<br>
推薦使用<a href="https://github.com/kimmobrunfeldt/concurrently" target="_blank" rel="noopener noreferrer">Concurrently<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>解決這件事：</p> <div class="language- extra-class"><pre class="language-text"><code>yarn add -D concurrently
</code></pre></div><div class="language-json extra-class"><pre class="language-json"><code><span class="token property">&quot;scripts&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
  <span class="token property">&quot;dev&quot;</span><span class="token operator">:</span> <span class="token string">&quot;concurrently \&quot;yarn:start\&quot; \&quot;yarn:mock\&quot;&quot;</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span>
</code></pre></div><hr> <p>End.</p></div> <footer><form class="newsletter"><div class="newsletter__wrap"><div class="newsletter__title">Newsletter</div> <div class="newsletter__content">Subscribe to get my latest content. No spam.</div> <div class="newsletter__fields"><input type="email" name="email" aria-label="Email" placeholder="Email" required="required" autocapitalize="off" autocorrect="off" data-cy="email" value="" class="newsletter__input"> <button type="submit" data-cy="submit" class="newsletter__button">
        Subscribe
      </button></div></div></form> <hr> <!----></footer></article> <div class="sticker vuepress-toc"><div class="vuepress-toc-item vuepress-toc-h2 active"><a href="#前言" title="前言">前言</a></div><div class="vuepress-toc-item vuepress-toc-h3"><a href="#json-server-能幹麻" title="json-server 能幹麻">json-server 能幹麻</a></div><div class="vuepress-toc-item vuepress-toc-h2"><a href="#開始" title="開始">開始</a></div><div class="vuepress-toc-item vuepress-toc-h3"><a href="#建立多檔案結構" title="建立多檔案結構">建立多檔案結構</a></div><div class="vuepress-toc-item vuepress-toc-h3"><a href="#db-js-自動引入檔案" title="db.js 自動引入檔案">db.js 自動引入檔案</a></div><div class="vuepress-toc-item vuepress-toc-h3"><a href="#監聽多檔案" title="監聽多檔案">監聽多檔案</a></div><div class="vuepress-toc-item vuepress-toc-h3"><a href="#更完整的-router" title="更完整的 router">更完整的 router</a></div><div class="vuepress-toc-item vuepress-toc-h2"><a href="#其他" title="其他">其他</a></div><div class="vuepress-toc-item vuepress-toc-h3"><a href="#中文解碼" title="中文解碼">中文解碼</a></div><div class="vuepress-toc-item vuepress-toc-h3"><a href="#post-轉成-get" title="POST 轉成 GET">POST 轉成 GET</a></div><div class="vuepress-toc-item vuepress-toc-h3"><a href="#同時運行-app-與-mock-server-在一個-terminal" title="同時運行 App 與 mock server 在一個 terminal">同時運行 App 與 mock server 在一個 terminal</a></div></div></div></div> <footer class="footer" data-v-3d9deeb8><div class="footer-left-wrap" data-v-3d9deeb8><ul class="contact" data-v-3d9deeb8><li class="contact-item" data-v-3d9deeb8><a href="https://github.com/billyyyyy3320" target="_blank" rel="noopener noreferrer" class="nav-link external" data-v-3d9deeb8><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-github" data-v-3d9deeb8><path d="M9 19c-5 1.5-5-2.5-7-3m14 6v-3.87a3.37 3.37 0 0 0-.94-2.61c3.14-.35 6.44-1.54 6.44-7A5.44 5.44 0 0 0 20 4.77 5.07 5.07 0 0 0 19.91 1S18.73.65 16 2.48a13.38 13.38 0 0 0-7 0C6.27.65 5.09 1 5.09 1A5.07 5.07 0 0 0 5 4.77a5.44 5.44 0 0 0-1.5 3.78c0 5.42 3.3 6.61 6.44 7A3.37 3.37 0 0 0 9 18.13V22" data-v-3d9deeb8></path></svg>
          
        </a></li><li class="contact-item" data-v-3d9deeb8><a href="mailto:newsbielt703@gmail.com" class="nav-link external" data-v-3d9deeb8><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-mail" data-v-3d9deeb8><path d="M4 4h16c1.1 0 2 .9 2 2v12c0 1.1-.9 2-2 2H4c-1.1 0-2-.9-2-2V6c0-1.1.9-2 2-2z" data-v-3d9deeb8></path><polyline points="22,6 12,13 2,6" data-v-3d9deeb8></polyline></svg>
          
        </a></li></ul></div> <div class="footer-right-wrap" data-v-3d9deeb8><ul class="copyright" data-v-3d9deeb8><li class="copyright-item" data-v-3d9deeb8>Billy Chin © 2019</li></ul></div></footer></div><div class="global-ui"><!----></div></div>
    <script src="/notes/assets/js/app.58d3274d.js" defer></script><script src="/notes/assets/js/10.1c61ee65.js" defer></script><script src="/notes/assets/js/1.cefec5dd.js" defer></script><script src="/notes/assets/js/26.9b23ff55.js" defer></script><script src="/notes/assets/js/5.32c25227.js" defer></script><script src="/notes/assets/js/11.dc79e7dc.js" defer></script>
  </body>
</html>
